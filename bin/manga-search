#! /usr/bin/env node --harmony

const package = require('../package.json');
const program = require('commander');
const Table = require('cli-table2');
const support = require('./support.json');
const Searcher = support.WEBSITES.reduce((requires,name,index) => {
    requires[name] = require(`../dist/crawler/${name}/search`).search;
    return requires;
},{});

function chunkString(str, length=1) {
    return (str || '').match(new RegExp('.{1,' + length + '}', 'g')) || [];
}

function cellLimit(str, limit = 30) {
    return chunkString(str, limit).join('\n');
}

function outputMangaAsTable(mangas){
    const HEAD = ['id','name','author','cover','end','description']
    let table = new Table({
        head: HEAD
    });
    mangas.forEach(manga => {
        let row = [];
        ['id','name','author','cover','end','description'].forEach(key=>{
            let text = manga[key];
            if (key === 'name') {
                text = cellLimit(text,20);
            } else if (key === 'end') {
                text = text === undefined ? '-' :
                    text ? '\u2714' : '\u2718';
            } else if (key === 'description') {
                text = cellLimit(text);
            }
            row.push(text);
        });

        table.push(row);
    });
    console.log(table.toString())
}

program
    .action((name,cmd) => {
        let keys = Object.keys(Searcher);
        Promise.all(
            keys.map(website => {
                return Searcher[website](name);
            })
        ).then(results => {
            let mangas = [];
            let len = results.reduce((arr1,arr2) =>
                arr1.length > arr2.length ? arr1 : arr2
            ).length;
            for (let i = 0; i < len; i++) {
                for (let j = 0; j < results.length; j++) {
                    let manga = results[j][i];
                    if (manga) {
                        manga.id = manga.id ? (keys[j] + '/' + manga.id) : null;
                        mangas.push(manga);
                    }
                }
            }
            return mangas;
        }).then(outputMangaAsTable)
        .catch(err => {
            console.error(err);
        });
    })
    .parse(process.argv);
