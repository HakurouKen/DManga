#! /usr/bin/env node --harmony

const package = require('../package.json');
const program = require('commander');
const support = require('./support.json');
const Searcher = support.WEBSITES.reduce((requires,name,index) => {
    requires[name] = require(`../dist/crawler/${name}/search`).search;
    return requires;
},{});

program
    .action((name,cmd) => {
        let keys = Object.keys(Searcher);
        Promise.all(
            keys.map(website => {
                return Searcher[website](name);
            })
        ).then(results => {
            let mangas = [];
            let len = results.reduce((arr1,arr2) =>
                arr1.length > arr2.length ? arr1 : arr2
            ).length;
            for (let i = 0; i < len; i++) {
                for (let j = 0; j < results.length; j++) {
                    let manga = results[j][i];
                    if (manga) {
                        manga.id = manga.id ? (keys[j] + '/' + manga.id) : null;
                        mangas.push(manga);
                    }
                }
            }
            return mangas;
        }).then(mangas => {
            console.log(mangas);
        });
    })
    .parse(process.argv);
